#!/bin/bash
# Ben Fasoli
# Integration testing for STILT R wrapper

# modified to test OCO-2/X-STILT features, DW, 06/01/2018

# Execute setup script and fetch the ubuntu-16.04 binary (option 3)
./setup 3

# Fetch the tutorial data
git clone https://github.com/uataq/stilt-tutorials

# Replace {{project}} and {{wd}}
sed -i 's|{{project}}|stilt|g' create_namelist_oco2-xstilt.r
sed -i "s|file.path('{{wd}}', project)|getwd()|g" create_namelist_oco2-xstilt.r

# Set receptor and footprint information
sed -i 's|recp.num <- 10|g' create_namelist_oco2-xstilt.r
#sed -i 's|2015-06-18 22:00:00|2015-12-10 00:00:00|g' create_namelist_oco2-xstilt.r
#sed -i 's|xmn <- -114.5|xmn <- -112.30|g' create_namelist_oco2-xstilt.r
#sed -i 's|xmx <- -109|xmx <- -111.52|g' create_namelist_oco2-xstilt.r
#sed -i 's|ymn <- 37|ymn <- 40.39|g' create_namelist_oco2-xstilt.r
#sed -i 's|ymx <- 42|ymx <- 40.95|g' create_namelist_oco2-xstilt.r
#sed -i 's|xres <- 0.01|xres <- 0.002|g' create_namelist_oco2-xstilt.r

# Set met_directory
#sed -i "s|'/uufs/chpc.utah.edu/common/home/lin-group6/hrrr/data/utah'|file.path(stilt_wd, 'stilt-tutorials/01-wbb/met')|g" create_namelist_oco2-xstilt.r

# Minimize run duration
#sed -i 's|n_hours    <- -24|n_hours <- -1|g' create_namelist_oco2-xstilt.r

# Print create_namelist_oco2-xstilt.r for diagnostics
cat create_namelist_oco2-xstilt.r

# Execute create_namelist_oco2-xstilt.r
Rscript create_namelist_oco2-xstilt.r

# Check output
model_output=$(ls out/by-id/2014122710_47.33935_23.0249_X/2014122710_47.33935_23.0249_X* | wc -l)
if [ $model_output -lt 2 ]; then
  echo "Model output not found."
  exit 1
fi

# Print contents of output directory
ls -lh out/by-id/2014122710_47.33935_23.0249_X

echo "Model test successful."
